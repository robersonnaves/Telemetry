services:
  # Jaeger Collector
  jaeger-collector:
    image: jaegertracing/jaeger-collector:latest
    container_name: jaeger-collector
    restart: unless-stopped
    environment:
      - SPAN_STORAGE_TYPE=memory
      - COLLECTOR_OTLP_ENABLED=true
    ports:
      - "14250:14250"  # gRPC
      - "14268:14268"  # HTTP
    networks:
      - telemetry
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:14269/"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Jaeger Query
  jaeger-query:
    image: jaegertracing/jaeger-query:latest
    container_name: jaeger-query
    restart: unless-stopped
    environment:
      - SPAN_STORAGE_TYPE=memory
      - QUERY_BASE_PATH=/
    ports:
      - "16686:16686"
    networks:
      - telemetry
    depends_on:
      - jaeger-collector
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:16686/"]
      interval: 30s
      timeout: 10s
      retries: 3

  # OpenTelemetry Collector
  otel-collector:
    image: otel/opentelemetry-collector-contrib:latest
    container_name: otel-collector
    restart: unless-stopped
    command: ["--config=/etc/otel-collector-config.yaml"]
    configs:
      - source: otel_config
        target: /etc/otel-collector-config.yaml
    ports:
      - "4317:4317"   # OTLP gRPC receiver
      - "4318:4318"   # OTLP HTTP receiver
      - "8888:8888"   # Prometheus metrics
      - "8889:8889"   # Prometheus exporter
    networks:
      - telemetry
    depends_on:
      - jaeger-collector
      - prometheus
      - loki
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8888/metrics"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Prometheus
  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    restart: unless-stopped
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/usr/share/prometheus/console_libraries'
      - '--web.console.templates=/usr/share/prometheus/consoles'
      - '--web.enable-lifecycle'
      - '--web.enable-remote-write-receiver'
      - '--enable-feature=exemplar-storage'
    ports:
      - "9090:9090"
    configs:
      - source: prometheus_config
        target: /etc/prometheus/prometheus.yml
    volumes:
      - prometheus-data:/prometheus
    networks:
      - telemetry
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:9090/-/healthy"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Loki
  loki:
    image: grafana/loki:latest
    container_name: loki
    restart: unless-stopped
    command: -config.file=/etc/loki/local-config.yaml
    ports:
      - "3100:3100"
    configs:
      - source: loki_config
        target: /etc/loki/local-config.yaml
    volumes:
      - loki-data:/loki
    networks:
      - telemetry
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3100/ready"]
      interval: 30s
      timeout: 10s
      retries: 3

  # cAdvisor
  cadvisor:
    image: gcr.io/cadvisor/cadvisor:latest
    container_name: cadvisor
    restart: unless-stopped
    privileged: true
    devices:
      - /dev/kmsg:/dev/kmsg
    volumes:
      - /:/rootfs:ro
      - /var/run:/var/run:ro
      - /sys:/sys:ro
      - /var/lib/docker/:/var/lib/docker:ro
      - /cgroup:/cgroup:ro
    ports:
      - "8080:8080"
    networks:
      - telemetry
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Grafana
  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    restart: unless-stopped
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=admin
      - GF_USERS_ALLOW_SIGN_UP=false
      - GF_USERS_ALLOW_ORG_CREATE=false
      - GF_AUTH_ANONYMOUS_ENABLED=false
      - GF_FEATURE_TOGGLES_ENABLE=grafanaManagedRecordingRules
    ports:
      - "3000:3000"
    volumes:
      - grafana-data:/var/lib/grafana
    networks:
      - telemetry
    depends_on:
      - prometheus
      - loki
      - jaeger-query
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:3000/api/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

configs:
  prometheus_config:
    content: |
      global:
        scrape_interval: 15s
        evaluation_interval: 15s
        external_labels:
          cluster: telemetry-stack
          environment: development

      rule_files:
        # - "first_rules.yml"
        # - "second_rules.yml"

      scrape_configs:
        # Prometheus itself
        - job_name: prometheus
          static_configs:
            - targets: [localhost:9090]
          scrape_interval: 5s
          metrics_path: /metrics

        # OpenTelemetry Collector metrics
        - job_name: otel-collector
          static_configs:
            - targets: [otel-collector:8888]
          scrape_interval: 10s
          metrics_path: /metrics

        # OpenTelemetry Collector Prometheus exporter
        - job_name: otel-collector-prometheus
          static_configs:
            - targets: [otel-collector:8889]
          scrape_interval: 10s
          metrics_path: /metrics

        # cAdvisor container metrics
        - job_name: cadvisor
          static_configs:
            - targets: [cadvisor:8080]
          scrape_interval: 15s
          metrics_path: /metrics
          scrape_timeout: 10s

        # Jaeger components (if they expose metrics)
        - job_name: jaeger-collector
          static_configs:
            - targets: [jaeger-collector:14269]
          scrape_interval: 30s
          metrics_path: /metrics
          scrape_timeout: 10s

        - job_name: jaeger-query
          static_configs:
            - targets: [jaeger-query:16687]
          scrape_interval: 30s
          metrics_path: /metrics
          scrape_timeout: 10s

        # Loki metrics
        - job_name: loki
          static_configs:
            - targets: [loki:3100]
          scrape_interval: 30s
          metrics_path: /metrics
          scrape_timeout: 10s

        # Grafana metrics
        - job_name: grafana
          static_configs:
            - targets: [grafana:3000]
          scrape_interval: 30s
          metrics_path: /metrics
          scrape_timeout: 10s

      # Remote write disabled to prevent loops
      # remote_write: []

  otel_config:
    content: |
      receivers:
        # OTLP receivers for modern applications
        otlp:
          protocols:
            grpc:
              endpoint: 0.0.0.0:4317
            http:
              endpoint: 0.0.0.0:4318

        # Jaeger receivers for compatibility
        jaeger:
          protocols:
            grpc:
              endpoint: 0.0.0.0:14250
            thrift_http:
              endpoint: 0.0.0.0:14268

        # Prometheus receiver for scraping metrics
        prometheus:
          config:
            scrape_configs:
              - job_name: otel-collector
                scrape_interval: 10s
                static_configs:
                  - targets: [localhost:8888]

      processors:
        # Batch processor to optimize data sending
        batch:
          send_batch_size: 1000
          timeout: 1s
          send_batch_max_size: 2000

        # Memory limiter to prevent OOM
        memory_limiter:
          check_interval: 1s
          limit_percentage: 85
          spike_limit_percentage: 75

        # Resource processor to add resource attributes
        resource:
          attributes:
            - key: service.name
              value: telemetry-stack
              action: upsert
            - key: service.version
              value: 1.0.0
              action: upsert
            - key: deployment.environment
              value: development
              action: upsert

      exporters:
        # OTLP exporter for traces to Jaeger
        otlp/jaeger:
          endpoint: jaeger-collector:14250
          tls:
            insecure: true

        # Debug exporter for logs
        debug:
          verbosity: basic

        # Prometheus exporter for collector metrics ONLY
        prometheus:
          endpoint: 0.0.0.0:8889

      extensions:
        health_check:
        pprof:
        zpages:

      service:
        extensions: [health_check, pprof, zpages]
        
        pipelines:
          # Traces pipeline - send to Jaeger
          traces:
            receivers: [otlp, jaeger]
            processors: [memory_limiter, batch, resource]
            exporters: [otlp/jaeger]

          # Metrics pipeline - expose for Prometheus scraping
          metrics:
            receivers: [otlp, prometheus]
            processors: [memory_limiter, batch, resource]
            exporters: [prometheus]

          # Logs pipeline - debug output
          logs:
            receivers: [otlp]
            processors: [memory_limiter, batch, resource]
            exporters: [debug]

        # Telemetry configuration
        telemetry:
          logs:
            level: info
          metrics:
            level: basic

  loki_config:
    content: |
      auth_enabled: false

      server:
        http_listen_port: 3100

      common:
        path_prefix: /loki
        storage:
          filesystem:
            chunks_directory: /loki/chunks
            rules_directory: /loki/rules
        replication_factor: 1
        ring:
          instance_addr: 127.0.0.1
          kvstore:
            store: inmemory

      schema_config:
        configs:
          - from: 2020-10-24
            store: tsdb
            object_store: filesystem
            schema: v13
            index:
              prefix: index_
              period: 24h

      analytics:
        reporting_enabled: false

      limits_config:
        retention_period: 168h

      compactor:
        working_directory: /loki/compactor

      ingester:
        wal:
          enabled: true
          dir: /loki/wal

volumes:
  jaeger-storage-data:
    driver: local
  prometheus-data:
    driver: local
  loki-data:
    driver: local
  grafana-data:
    driver: local

networks:
  telemetry:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16